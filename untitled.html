// routes/user.routes.js

const express = require("express");
const session = require('express-session');
const router = express.Router();

const { check, validationResult } = require('express-validator');


router.post('/create-user',
    [
        check('name')
            .not()
            .isEmpty()
            .withMessage('Name is required'),
        check('email', 'Email is required')
            .isEmail(),
        check('password', 'Password is requried')
            .isLength({ min: 1 })
            .custom((val, { req, loc, path }) => {
                if (val !== req.body.confirm_password) {
                    throw new Error("Passwords don't match");
                } else {
                    return value;
                }
            }),
    ], (req, res) => {
        var errors = validationResult(req).array();
        if (errors) {
            req.session.errors = errors;
            req.session.success = false;
            res.redirect('/user');
        } else {
            req.session.success = true;
            res.redirect('/user');
        }
    });

router.get('/', function (req, res) {
    res.render('user', {
        success: req.session.success,
        errors: req.session.errors
    });
    req.session.errors = null;
});


module.exports = router;

{{#if hasErrors}}
    <div class="alert alert-danger" role="alert">
      {{#each error}}
        <p>{{this}}</p>
      {{/each}}  
    </div>
  {{/if}}

 var errors = validationResult(req);

    if(!errors.isEmpty()){
        // var error = [];
        // errors.forEach(function(error){
        var errorMessage = errors.array().map(function (elem) {
            return elem.msg;
        }); 


        // });
        console.log(errorMessage);
        return res.render("signup", {
            error: errorMessage, hasErrors: errorMessage.length >0 


router.get('/register', function(req, res) {
  res.render('auth/register');
});

router.post('/register', function(req, res) {

  // omitted code to trim and validate

  User.count({ 'username': req.body.username }, function (err, count) { // check if user exists
    if (err) throw err;

    req.getValidationResult().then(function(result) {

      var errors = result.array();

      if (count>0) {
        errors.push( { param: 'username', msg: 'That username is already in use.', value: 'u'} );
      }
      if (errors.length) {
        res.render('auth/register', {
          errors: errors
        });
      } else {
        var newUser = new User({
          name: req.body.name,
          username: req.body.username,
          password: req.body.password,
          city: req.body.city,
          state: req.body.state,
          country: req.body.country,
          email: req.body.email
        });
        User.createUser(newUser, function(err, user) {  // create new user
          if (err) throw err;
          req.flash("success_msg", "You are registered and can now log in.");
          res.redirect("/users/login");
        });
      }
    });
  });
});
